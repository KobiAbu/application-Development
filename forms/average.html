<!DOCTYPE html>
<html data-bs-theme="light" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Statistical Data</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <!-- Other stylesheets and links -->
</head>

<body id="gridContainer">
    <div class="collapse navbar-collapse" id="navcol-1">
        <ul class="nav nav-tabs">
            <li class="nav-item"><a class="nav-link" href="products.html">catalog</a></li>
            <li class="nav-item"><a class="nav-link" href="sign_up.html">sign up</a><a class="nav-link"
                    href="log_in.html">log in</a></li>
        </ul>
        <a class="btn btn-primary ms-auto" role="button" href="/cart.html">cart</a><a class="navbar-brand"
            href="index.html">Gold street</a>
    </div>
    <nav class="navbar navbar-expand-md navbar-light">
        <div class="container-fluid"><img src="assets/img/Letter-G-Jewelry-Logo%20(1).jpg" width="38" height="38"><a
                class="navbar-brand" href="index.html">Gold street</a>
            <div class="collapse navbar-collapse" id="navcol-2" style="margin-left: 17px;">
                <ul class="navbar-nav" style="width: 432.125px;padding-right: 0px;">
                    <li class="nav-item"><a class="nav-link" href="#"></a></li>
                    <li class="nav-item"><a class="nav-link" href="products.html"
                            style="margin-left: -84px;">catalog</a></li>
                    <li class="nav-item"><a id="signUp" class="nav-link" href="sign_up.html">sign up</a></li>

                    <li class="nav-item"><a id="log" class="nav-link" href="log_in.html">log in</a></li>
                    <li class="nav-item"><a id="mngArea" class="nav-link" href="managerArea.html" style="visibility: hidden">manager
                            area</a></li>
                    <li class="nav-item"><a id="logOut" class="nav-link" href="" style="visibility: hidden">log out</a>
                    </li>

                </ul>
                <a id="prsArea" class="btn btn-primary ms-auto" role="button" href="userSet.html"
                    style="visibility: hidden">personal
                    area</a>
                <a class="btn btn-primary ms-auto" role="button" href="/cart.html">cart</a>
            </div>
        </div>
    </nav>

    <div class="container text-center mt-4">
        <h1>Statistical Data</h1>
        <div class="row">
            <div class="col-md-6">
                <h2>Average Cumulative Amount of Purchases per Month</h2>
                <div id="averagePurchaseChart"></div>
            </div>
            <!-- Add another graph here -->
        </div>
    </div>

    

    <script src="./assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="./assets/js/bs-init.js"></script>
    <script src="./assets/js/Grid-and-List-view-V10-script.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <script>
        $(document).ready(async function () {
            $(logOut).click(function (e) {
                e.preventDefault()
                $.ajax({
                    url: "/logOut",
                    success: function (response) {
                        window.location.href = "index.html";
                    }
                });
            })
            $.ajax({
            type: "GET",
            url: "/getUserType",
            success: function (response) {

                if (response) {
                    if (response === 'admin') {
                        var mng = document.getElementById('mngArea')
                        mng.style.visibility = 'visible'
                    }
                    if (response === 'user') {
                        var persArea = document.getElementById('prsArea')
                        persArea.style.visibility = 'visible'

                    }
                    var logIn = document.getElementById('log')
                    var signUp = document.getElementById('signUp')
                    var logOut = document.getElementById('logOut')
                    logIn.style.visibility = 'hidden'
                    signUp.style.visibility = 'hidden'
                    logOut.style.visibility = 'visible'
                }

            }
        });
            const margin = { top: 20, right: 30, bottom: 30, left: 40 };
            const width = 500 - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;
            
            const svg = d3.select("#averagePurchaseChart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            async function fetchOrderData() {
                try {
                    const response = await fetch('http://localhost:8082/itemController'); // Update the endpoint
                    if (!response.ok) {
                        throw new Error('Failed to fetch data');
                    }
                    const orderData = await response.json();
                    return orderData;
                } catch (error) {
                    console.error('Error fetching order data:', error);
                    return [];
                }
            }

            const orderData = await fetchOrderData();

            // Calculate average cumulative amounts
            let cumulativeSum = 0;
            const cumulativeAmounts = orderData.map(entry => {
                cumulativeSum += entry.totalAmount;
                return cumulativeSum;
            });

            const x = d3.scaleBand()
                .domain(orderData.map(entry => entry._id))
                .range([0, width])
                .padding(0.1);

            const y = d3.scaleLinear()
                .domain([0, d3.max(cumulativeAmounts)])
                .nice()
                .range([height, 0]);

            svg.append("g")
                .attr("class", "x-axis")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x));

            svg.append("g")
                .attr("class", "y-axis")
                .call(d3.axisLeft(y));

            svg.selectAll(".bar")
                .data(cumulativeAmounts)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", (d, i) => x(orderData[i]._id))
                .attr("width", x.bandwidth())
                .attr("y", d => y(d))
                .attr("height", d => height - y(d));
        });
    </script>
</body>

</html>
